---
layout: post
title: 'WS-2016-7107: CSRF tokens in Spring and the BREACH attack'
date: 2021-04-14 17:28:59.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Security
tags:
- Java
- Security
- Spring
- Vulnerability
meta:
  _edit_last: '1'
  _yoast_wpseo_estimated-reading-time-minutes: '3'
  _oembed_57d72e6511eab5903ae5be60bb95cd38: <a class="twitter-timeline" data-width="625"
    data-height="938" data-dnt="true" href="https://twitter.com/artem_smotrakov?ref_src=twsrc%5Etfw">Tweets
    by artem_smotrakov</a><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script>
  _oembed_time_57d72e6511eab5903ae5be60bb95cd38: '1618402853'
  _yoast_wpseo_primary_category: '157'
  _yoast_wpseo_focuskw: WS-2016-7107
  _yoast_wpseo_metadesc: 'WS-2016-7107: what is this, what is BREACH, how to detect
    and mitigate this issue in a Spring-based application.'
  _yoast_wpseo_linkdex: '64'
  rp4wp_auto_linked: '1'
  _yoast_wpseo_content_score: '60'

permalink: "/en/security/csrf-tokens-in-spring-and-the-breach-attack.html"
---
<!-- wp:paragraph -->

Recently WhiteSource security scanner started reporting WS-2016-7107 against Spring-based applications. This is an old [issue](https://github.com/spring-projects/spring-security/issues/4001) in Spring Security that was reported in 2016. Unfortunately, at the moment of writing it, the issue has not been fixed yet. But there is a [pull request](https://github.com/spring-projects/spring-security/pull/8082) that should address it. The problem is that CSRF tokens generated by Spring Security are vulnerable to the [BREACH](http://breachattack.com/) attack. The attack is even older -- it was published in 2013. The BREACH attack is similar to the CRIME attack but BREACH doesn't need TLS compression.

<!-- /wp:paragraph -->

<!-- wp:paragraph -->

(you can also read it on [Medium](https://infosecwriteups.com/ws-2016-7107-csrf-tokens-in-spring-and-the-breach-attack-4394b10d1b8))

<!-- /wp:paragraph -->

<!-- wp:image {"id":4138,"sizeSlug":"large","linkDestination":"none","className":"noborder"} -->

![WS-2016-7107: CSRF tokens in Spring and the BREACH attack]({{ site.baseurl }}/assets/images/2021/04/cowsay_spring_and_breach.png)

<!-- /wp:image -->

<!-- wp:more -->  
<!--more-->  
<!-- /wp:more -->

<!-- wp:paragraph -->

There are several conditions for a successful attack:

<!-- /wp:paragraph -->

<!-- wp:list {"ordered":true} -->

1. The attacker should be able to inject partially chosen plaintext into the victim's requests (that is usually called chosen-plaintext attack model).
2. The attacker should be able to observe the encrypted traffic from the victim.
3. HTTP compression should be enabled.

<!-- /wp:list -->

<!-- wp:paragraph -->

TLS configuration doesn't matter. In the case of a Spring-based application, a successful attack allows the attacker to recover the victim's CSRF tokens. That's what WS-2016-7107 is about.

<!-- /wp:paragraph -->

<!-- wp:paragraph -->

The issue seems to get quite a lot of attention because WhiteSource reports it against almost all applications that use Spring Framework. Look at the number of [linked WhiteSource reports](https://github.com/spring-projects/spring-security/issues/4001) in the original issue on GitHub. And that's only projects on GitHub that use WhiteSource. What makes it worse is that the issue is still open. Therefore, it is not possible to fix this issue in an application just by bumping the version of Spring Security. Furthermore, if the proposed fix is accepted, it will be likely released only in the next major update of Spring Security because the fix updates the public API.

<!-- /wp:paragraph -->

<!-- wp:paragraph -->

Looks like the most reliable way to eliminate the risk of the BREACH attack completely is to make sure that HTTP compression is disabled. The good news is that HTTP compression is [disabled by default](https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#common-application-properties-server) in the latest version of Spring Boot. Unless an application sets the property `server.compression.enabled` to `true`, the BREACH attack should not be possible. To be sure, it would be better to test whether HTTP compression is enabled on not:

<!-- /wp:paragraph -->

<!-- wp:preformatted {"className":"console"} -->

```
GET /path/to/something HTTP/1.1
Host: test.server.com
Accept-Encoding: gzip, deflate
```

<!-- /wp:preformatted -->

<!-- wp:paragraph -->

Here is how you can do it with `curl`:

<!-- /wp:paragraph -->

<!-- wp:preformatted {"className":"console"} -->

```
curl -v -H "Accept-Encoding: gzip, deflate" https://test.server.com/path/to/something
```

<!-- /wp:preformatted -->

<!-- wp:paragraph -->

If the server returns "Content-Encoding" header with a list of supported compression methods, then HTTP compression is on. [Wikipedia](https://en.wikipedia.org/wiki/HTTP_compression#Compression_scheme_negotiation) has an example of such a response. Otherwise, HTTP compression is off.

<!-- /wp:paragraph -->

<!-- wp:paragraph -->

If HTTP compression has to be on, there may be another option. The application can implement a custom `CsrfTokenRepository` that applies the unreleased [fix](https://github.com/spring-projects/spring-security/pull/8082) for Spring Security. I have not tested this option though.

<!-- /wp:paragraph -->

<!-- wp:paragraph -->

Let's hope the issue will be fixed soon in Spring Security.

<!-- /wp:paragraph -->

